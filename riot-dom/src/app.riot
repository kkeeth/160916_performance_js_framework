<app-component>
  <div class="particle-container">
    <particle-obj each={ particle in state.particles }
                  particle={ particle }
                  item={ state.particleItem } />
  </div>
  <div class="ui">
    <p>Emit Particle Per 1 Frame</p>
    <input type="range"
           name="emitOnFrame"
           value={ state.emitOnFrame }
           onchange={ handleChange }
           min="1"
           max="50" />
    <input type="number"
           name="emitOnFrame"
           value={ state.emitOnFrame }
           onchange={ handleChange }
           min="1"
           max="50" />

    <p>ç¾åœ¨ã®ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«æ•° : { state.particles.length } å€‹</p>
    <span>ç¾åœ¨ã®ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ« : </span>
    <select onchange={ handleSelect }>
      <option value="ğŸ˜Š">ğŸ˜Š</option>
      <option value="ğŸ£">ğŸ£</option>
      <option value="ğŸº">ğŸº</option>
    </select>
  </div>

  <script>
    import { register } from 'riot'
    import { ParticleData } from './particle'
    import ParticleObj from './particle-obj.riot'
    let count = 0

    export default {
       components: {
          ParticleObj
       },
       onBeforeMount() {
          this.state = {
             particles: [],
             emitOnFrame: 3,
             particleItem: 'ğŸ˜Š'
          }
       },
       onMounted() {
          this.tick()
          this.update()
       },
       /** ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ•ãƒ¬ãƒ¼ãƒ ã‚¤ãƒ™ãƒ³ãƒˆã§ã™ã€‚ */
       tick() {
          const particles = this.state.particles.concat()
          // ç™ºç”Ÿ
          const len = Number(this.state.emitOnFrame)
          for (let i = 0; i < len; i++) {
            particles.push(new ParticleData(
              window.innerWidth / 2,
              window.innerHeight / 4,
              this.count++
            ))
          }

          // æ›´æ–°
          particles.forEach((particle, index) => {
             // ãƒ©ãƒ³ãƒ€ãƒ ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆãŒç„¡åŠ¹ã®å ´åˆã¯å¸¸ã«ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã™ã‚‹
             particle.update()

             // å¯¿å‘½ã®åˆ¤å®š
             if (particle.life <= 0) {
                // é…åˆ—ã‹ã‚‰ã‚‚å‰Šé™¤
                particles.splice(index, 1)
             }
          })

          // æ›´æ–°
          this.state.particles = particles
          this.update()
          requestAnimationFrame(() => {
            this.tick()
          })
       },
       handleChange(e) {
         // ã‚­ãƒ£ã‚¹ãƒˆã—ãªã„ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹
         this.state.emitOnFrame = Number(e.currentTarget.value)
         this.update()
       },
       handleSelect(e) {
         this.state.particleItem = e.currentTarget.value
       }
    }
  </script>

  <style scoped>
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
    }

    .ui {
      position: absolute;
      top: 10px;
      right: 10px;
    }

    .particle {
      font-size: 2rem;
      position: absolute;
    }

    .particle-container {
      position: absolute;
    }
  </style>
</app-component>
